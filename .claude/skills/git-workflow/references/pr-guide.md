# PR 절차

## ⚠️ 필수 규칙

### Push는 확인 없이 바로 진행

`/pr` 명령어는 PR 생성 의도가 명확하므로 push 여부를 물어보지 않고 바로 진행합니다.

### 커밋 전 사용자 확인 필수

**이 명령어는 기존 커밋만 push합니다. 새로운 커밋을 생성하지 않습니다.**

커밋되지 않은 변경사항이 있는 경우:

1. 변경 파일 목록과 내용을 사용자에게 보여줌
2. AskUserQuestion으로 커밋 진행 여부 확인
3. 사용자가 승인한 경우에만 커밋 후 PR 진행
4. 사용자가 거부하면 PR 생성/갱신 없이 종료

**절대 금지**: 사용자 확인 없이 임의로 커밋하는 행위

---

## 실행 순서

### Step 0: Target Branch 선택

AskUserQuestion 도구를 사용하여 target branch를 질문:

- 질문: "PR의 target branch를 선택하세요"
- 옵션:
  - `main` (기본, 일반적인 feature PR)
  - `hotfix` (긴급 수정)
  - 사용자가 "Other"를 선택하면 직접 branch 이름 입력

선택된 branch를 `<target-branch>`로 사용합니다.

### Step 1: Push

```bash
git push -u origin HEAD
```

### Step 2: PR 확인 및 생성/갱신

1. 현재 브랜치에 대한 **Open 상태**의 PR이 있는지 확인:

```bash
gh pr list --head $(git branch --show-current) --state open --json number,title,url
```

2. PR 존재 여부에 따라 분기:

**Open PR이 이미 존재하는 경우:**

- 사용자에게 PR 정보를 보여주고 덮어쓸 것인지 확인
- AskUserQuestion 도구를 사용하여 질문:
  - "기존 PR을 갱신하시겠습니까?"
  - 옵션: "갱신" (기존 PR 업데이트) / "스킵" (PR 갱신 없이 Code Review만 진행)
- 사용자가 "스킵"을 선택하면 Step 3으로 바로 이동

**Open PR이 없는 경우 (closed 포함):**

- 새로 생성

3. PR 생성 또는 갱신:

**PR 생성 시:**

- base branch: Step 0에서 선택한 `<target-branch>`
- 제목: prefix(`feat:`, `fix:` 등)와 이슈번호(`#123`) 없이 작성
- 커밋 목록은 PR 생성 후 `gh pr view --json commits`로 가져옴

**PR 갱신 시:**

- `gh api` 명령으로 제목과 본문 업데이트
- 커밋 목록은 `gh pr view <PR번호> --json commits`로 가져옴 (실제 PR에 포함된 커밋만)

---

## PR 본문 구조

```markdown
## Summary

- 변경사항 요약 (bullet points, 1-3줄)

## Details

(Summary보다 상세한 설명. 변경 배경, 주요 변경점, 영향 범위 등)

## Changes

(변경된 파일 목록을 tree 형식으로 표시)

## Commits

- [`abc1234`](https://github.com/owner/repo/commit/abc1234) 커밋 메시지 (이슈번호 제외)

## Test plan

- [ ] 테스트 항목
```

---

## Details 섹션 작성 규칙

1. **생략 가능**: 단순 변경(오타 수정, 설정 변경 등)은 Details 생략
2. **접이식 구조**: `<details><summary>` 태그로 항목별 접이식 구성
   - 평소에는 제목만 보이고, 클릭하면 상세 내용 펼침
3. **작성 내용 예시**:

   - 왜 이 변경이 필요한지 (배경)
   - 어떤 방식으로 해결했는지 (접근법)
   - 기존 동작과 달라지는 점 (영향)

4. **예시**:
   ```
   ## Details
   <details>
   <summary><b>TASK-0101: 개발/검증 DB 분리 (완료)</b></summary>
   - **계획 변경**: 3개 프로젝트 → 2개 프로젝트 + Local (Docker)
   - **시드 데이터**: 스크립트 작성 → Staging 복제 방식으로 변경
   - **추가 구현**: Claude Code 커맨드 7종 생성
   </details>
   ```

---

## Changes 섹션 작성 규칙 (필수!)

1. **변경 파일 목록 조회** (누락 방지):

   ```bash
   # 반드시 origin/<target-branch> 기준으로 비교 (local branch 아님!)
   # local branch는 최신화가 안 되어 있을 수 있으므로 origin 기준 필수
   git diff origin/<target-branch>..HEAD --name-only
   ```

2. **모든 파일 포함**: 위 명령 결과의 모든 파일을 빠짐없이 tree에 포함

3. **tree 형식으로 구조화**:

   - 공통 상위 디렉토리 기준으로 그룹화
   - 각 파일에 간단한 설명 주석 추가
   - 코드 블록 내에 작성하여 monospace 정렬 유지

4. **폴더 단위 요약** (파일 수가 많은 경우):

   - 폴더 내 leaf 파일(하위 폴더가 아닌 파일)이 **5개 이상**인 경우
   - 개별 파일을 나열하지 않고 **폴더 단위**로 표시 (`dir/`로 끝냄)
   - 폴더명 옆에 변경 내용을 요약 설명
   - **nested tree 구조 유지**: 평탄화하지 않고 계층 구조 그대로 표현

5. **예시**:

   ````
   ## Changes
   ```
   .claude/commands/
   ├── db-local-init.md           # 로컬 DB 초기화 커맨드
   ├── db-local-reset.md          # 로컬 DB 리셋 커맨드
   └── storage-migration.md       # 스토리지 마이그레이션
   src/
   ├── components/
   │   ├── Header.tsx             # 헤더 스타일 수정
   │   ├── Footer.tsx             # 푸터 링크 추가
   │   └── blog/
   │       └── postMain/          # PostMain 관련 Tailwind 마이그레이션 (12개 파일)
   └── styles/                    # SCSS 파일 제거 및 globals.css 통합 (8개 파일)
   ```
   ````

6. **검증**: tree 작성 후 `git diff --name-only` 결과와 대조하여 누락 파일 없는지 확인

---

## Step 3: Code Review (터미널 출력)

PR diff를 분석하여 터미널에 리뷰 결과를 출력합니다:

1. PR diff 가져오기:

```bash
gh pr diff
```

2. diff를 분석하여 다음 형식으로 리뷰 결과 출력:

```
## Code Review Summary

### 변경 사항 요약
- 주요 변경 내용 설명

### 잘된 점 ✅
- 긍정적인 부분

### 개선 제안 💡
- 파일명:라인번호 - 제안 내용
- 파일명:라인번호 - 제안 내용

### 주의 사항 ⚠️
- 잠재적 이슈나 주의점
```

---

## PR 규칙 (필수 준수)

1. **PR 제목**: prefix(`feat:`, `fix:` 등)를 붙이지 않음
2. **PR 제목**: 이슈번호(`#123`)를 붙이지 않음
3. **Commits 섹션**:
   - `gh pr view <PR번호> --json commits`로 실제 PR 커밋만 가져옴
   - 이슈번호 제외, GitHub commit 링크 포함
4. **Changes 섹션 (중요!)**:
   - `git diff origin/<target-branch>..HEAD --name-only`로 변경 파일 전체 목록 조회
   - **반드시 `origin/` prefix 사용** (local branch는 최신화가 안 되어 있을 수 있음)
   - **모든 파일을 누락 없이** tree 형식으로 포함
   - 코드 블록 내 monospace 정렬 유지
   - 파일별 간단한 설명 주석 추가
5. **커밋 메시지 자체**는 기존 컨벤션 유지 (`feat: ... #123`)
6. **AI 관련 문구 절대 금지**: `Generated by Claude Code`, `Co-Authored-By: Claude`, 기타 AI 도구 언급 금지

---

## 예시 출력

입력: `/pr`

출력:

0. 🔀 Target branch: `develop` 선택
1. ✅ Push 완료
2. ✅ PR 생성/갱신 완료: https://github.com/owner/repo/pull/123
3. ✅ Code Review 결과 (터미널 출력)

---

## summary.json 작성

PR 생성/갱신 완료 후 `.claude/summary.json` 작성:

```json
{
  "request": "PR 생성 요청",
  "response": "[Discord 알림 hook 시스템 추가#116](https://github.com/Orchemi/huns-log/pull/116)",
  "started_at": "..."
}
```

**규칙:** 특수문자/줄바꿈 금지, PR 제목과 링크 포함
